# Сети в Linux

## Part 1. Инструмент ipcalc

### 1.1 Сети и маски
  
+ ***1.***
  
  ***Адрес сети 192.167.38.54/13***

  ![1](images/1.png)
  
+ ***2.*** 
  
  ***Перевод маски 255.255.255.0 в префиксную и двоичную запись***
  
  ***В префиксной равен 24, тк состаляет 3 полных октета (3 * 8)***
   
  ***В двоичной:***

  ![2](images/2.png)
  
  ***/15 в обычной и двоичночной***
  
  ***В обычной равен 255.254.0.0, т.к 1 полный октет и 254 = 7 (без конечной 1)***
  
  ***В двоичной равен (11111111.11111110.0.0), без той самой единицы***
  
  ![3](images/3.png)
  
  ***11111111.11111111.11111111.11110000 в обычную и префиксную***
  
  ***В обычной равен 255.255.255.240***
  
  ***В префиксой равен 28, тк 3 полных октета и 240 = 4 (16 = 4, 8 -4 = 4)***
  
  ![4](images/4.png)
  
+ ***3.***

  ***Минимальный и максимальный хост в сети 12.167.38.4 при масках: /8, 11111111.11111111.00000000.00000000, 255.255.254.0 и /4***
  
  ![5](images/5.png)
  
### 1.2 localhost
  
+ ***Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1***

  ***194.34.23.100 - нет***

  ***127.0.0.2 - да***

  ***127.1.0.1 - да***

  ***128.0.0.1 - нет***

### 1.3 Диапазоны и сегменты сетей
  
  ***Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1***

  ![6](images/6.png)

  ***Какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255***

  ![7](images/7.png)

  ***Поэтому возможны только [10.10.0.2] [10.10.10.10] [10.10.1.255]***

## Part 2. Статическая маршрутизация между двумя машинами

+ ***ip a для ws1, ws2***
  
  ![8](images/8.png)

+ ***Описан сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и заданы следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12***
  
  ![9](images/9.png)

+ ***Вызов команды netplan apply***
  
  ![10](images/10.png)

### 2.1. Добавление статического маршрута вручную

+ ***Добавление статического маршрута, пропинговка***
  
  ![11](images/11.png)

### 2.2. Добавление статического маршрута с сохранением

+ ***Добавление статического маршрута и пропинговка без команды ip r add и пропинговка***
  
  ![12](images/12.png)

  ![13](images/13.png)

## Part 3. Утилита iperf3

### 3.1. Скорость соединения

+ ***Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps***
  
  ***8 Mbps = 1 MB/s***

  ***100 MB/s = 819200 Kbps***

  ***1 Gbps = 1024 Mbps***

### 3.2. Утилита iperf3

+ ***Измерить скорость соединения между ws1 и ws2***
  
  ![14](images/14.png)

## Part 4. Сетевой экран

### 4.1. Утилита iptables

+ ***Нужно добавить в файл подряд следующие правила:***
  
  ***1) на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)***

  ***2) на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)***

  ***3) открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)***

  ***4) запретить echo reply (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)***

  ***5) разрешить echo reply (машина должна "пинговаться")***

  ***Правила для первой и второй машин***

  ![15](images/15.png)

  ***Даем разрешение на использование скрипта, после чего пропинговываем IP ws2 (успешная пропинговка), и пропинговываем IP ws1 (пропинговка блокируется)***

  ![16](images/16.png)

  ***Разница заключается в следующем - файл читается сверху-вниз, у ws1 стоит первым правилом проверка на пропинговку своего IP (DROP), вторым правилом стоит на проинговку второй (ACCEPT), аналогично у ws2, только правила поменены местами, иначе говоря - это все приоритет.***

### 4.2. Утилита nmap

+ ***Командой ping найти машину, которая не "пингуется", после чего утилитой nmap показать, что хост машины запущен***
  
  ![17](images/17.png)

  ***На скрине видно, что вторая пингуется (все окей), первая не пингуется (все окей), прописываем nmap у первой, видимо надпись "Host is up", прописываем nmap у ws2 с IP ws1 - надпись "Host is up".***

## Part 5. Статическая маршрутизация сети

### 5.1. Настройка адресов машин

***Cкрины с содержанием файла etc/netplan/00-installer-config.yaml для каждой машины:***

+ ***WS11***
  
  ![ws11](images/ws11.png)

+ ***WS21***
  
  ![ws21](images/ws21.png)

+ ***WS22***
  
  ![ws22](images/ws22.png)

+ ***r1***
  
  ![r1](images/r1.png)

+ ***r2***
  
  ![r2](images/r2.png)

***Перезапустить сервис сети. Если ошибок нет, то командой ip -4 a проверить, что адрес машины задан верно.***

+ ***WS11***
  
  ![ws11_ip](images/ws11_ip.png)

+ ***WS21***
  
  ![ws21_ip](images/ws21_ip.png)

+ ***WS22***
  
  ![ws22_ip](images/ws22_ip.png)

+ ***r1***
  
  ![r1_ip](images/r1_ip.png)

+ ***r2***
  
  ![r2_ip](images/r2_ip.png)

***Пропинговать ws22 с ws21. Аналогично пропинговать r1 с ws11.***

+ ***Пропинговка ws22 с ws21***
  
  ![ws22_ping](images/ws22_ping.png)

+ ***Пропинговка r1 с ws11***
  
  ![ws11_ping](images/w11_ping.png)

### 5.2. Включение переадресации IP-адресов.

+ ***Использование команды "sysctl -w net.ipv4.ip_forward=1" в r1 и r2***
  
  ![ip_forward=1](images/ip_forward=1.png)

+ ***Добавление строчки "net.ipv4.ip_forward=1" в "/etc/sysctl.conf"***

  ![sysctl_conf](images/sysctl_conf.png)

### 5.3. Установка маршрута по-умолчанию

+ ***Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить default перед IP роутера в файле конфигураций***
  
  ***WS11 Netplan***
  
  ![def_ws11](images/def_ws11.png)

  ***WS21 Netplan***
  
  ![def_ws21](images/def_ws21.png)

  ***WS22 Netplan***
  
  ![def_ws22](images/def_w22.png)

+ ***Вызов ip r для станций***
  
  ***WS11 ip r***

  ![ip_r_ws11](images/ip_r_ws11.png)

  ***WS21 ip r***

  ![ip_r_ws21](images/ip_r_ws21.png)

  ***WS22 ip r***

  ![ip_r_ws22](images/ip_r_ws22.png)

+ ***Пропинговка r2 с ws11***
  
  ![dump](images/dump.png)

### 5.4. Добавление статических маршрутов

+ ***netplan r1/r2***
  
  ![r1_r2](images/r1_r2.png)

+ ***ip r r1/r2***
  
  ![ip_r1_r2](images/ip_r1_r2.png)

+ ***ip r list 10.10.0.0/[маска сети] и ip r list 0.0.0.0/0***
  
  ![ip_r_mask](images/ip_r_mask.png)

+ ***Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, потому что при наличии нескольких маршрутов одинаковой длины выбирается тот маршрут, который задан наиболее точно.***

### 5.5. Построение списка маршрутизаторов

+ ***Вывод команд traceroute и tcpdump***
  
  ![traceroute](images/traceroute.png)

  ***Утилита Traceroute вместо ICMP-запроса отправляет 3 UDP-пакета на определенный порт целевого хоста и ожидает ответа о недоступности этого порта. Первый пакет отправляется с TTL=1, второй с TTL=2 и так далее, пока запрос не попадёт адресату. Так как вместо ICMP-запроса он отправляет UDP-запрос, в каждом запросе есть порт отправителя и порт получателя. По умолчанию запрос отправляется на закрытый порт 34434. Когда запрос попадёт на хост назначения, этот хост отправит ответ о недоступности порта «Destination port unreachable» (порт назначения недоступен). Это значит, что адресат получил запрос. Traceroute воспримет этот ответ как завершение трассировки.***

### 5.6. Использование протокола ICMP при маршрутизации

+ ***Пинг несуществующего ip, дамп с r1***
  
  ![unlife](images/unlife.png)

## Part 6. Динамическая настройка IP с помощью DHCP

+ ***Для r2 настроить в файле /etc/dhcp/dhcpd.conf конфигурацию службы DHCP:***
  
  ***1) указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.***

  ![netmask](images/netmask.png)

  ***2) в файле resolv.conf прописать nameserver 8.8.8.8.***

  ![nameserver](images/nameserver.png)

+ ***Перезагрузить службу DHCP командой systemctl restart isc-dhcp-server.***
  
  ![restart_isc_dhcp_server](images/restart_isc_dhcp.png)

+ ***Машину ws21 перезагрузить при помощи reboot и через ip a показать, что она получила адрес.***
  
  ![get_ip](images/get_ip.png)

+ ***Также пропинговать ws22 с ws21.***
  
  ![ping_ws21_ws22](images/ping_ws21_ws22.png)

+ ***Указать MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: macaddress: 10:10:10:10:10:BA, dhcp4: true***
  
  ![mac_addr](images/mac_addr.png)

+ ***Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты***
  
  ***dhcp.conf r1***

  ![netmask_r1](images/netmask_r1.png)

  ***resolv.conf r1***
  
  ![resolv_r1](images/resolv_r1.png)

  ***restart для r1***
  
  ![restart_r1](images/restart_r1.png)

  ***Ребутаемся и проверяемся(все ок)***

  ![ip_reboot_ws11](images/ip_reboot_ws11.png)

+ ***Запросить с ws21 обновление ip адреса***
  
  ***Было по ip a***

  ![ip_was_ws21](images/ip_was_ws21.png)

  ***Использова dhclient -r и вывод ip a***

  ![ip_now_ws21](images/ip_now_ws21.png)

+ ***Какими опциями DHCP сервера пользовались в данном пункте:***
  
  ***Настройка конфигурации службы DHCP (адрес маршрутизатора по-умолчанию, DNS-сервер, адрес внутренней сети, привязка к MAC-адресу)***

  ***Клиент протокола динамической конфигурации хоста (команда dhclient) для обновления или освобождения IP-адреса***

## Part 7. NAT

+ ***В файле /etc/apache2/ports.conf на ws22 и r1 изменить строку Listen 80 на Listen 0.0.0.0:80, то есть сделать сервер Apache2 общедоступным***
  
  ![apache2](images/apache2.png)

+ ***Запустить веб-сервер Apache командой service apache2 start на ws22 и r1***
  
  ![apache2_start](images/apache2_start.png)

+ ***Добавить в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:***
  
  ***1) удаление правил в таблице filter - iptables -F***
  
  ***2) удаление правил в таблице "NAT" - iptables -F -t nat***

  ***3) отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP***

  ![r2_firewall](images/r2_firewall.png)

+ ***Запуск /etc/firewall.sh на r2, а также проверка соединения между ws22 и r1(пропинговка с r1 не пропинговывается, все ок)***
  
  ![ping_ws22_r1](images/ping_ws22_r1.png)

+ ***Разрешаем маршрутизацию всех пакетов протокола ICMP, после чего пропинговываем c r1 ws22***
  
  ![ping](images/ping.png)

+ ***Добавить в файл ещё два правила:***
  
  ***5) включить SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)***

  ***6) включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети***

  ![firewall_after](images/firewall_afte.png)

+ ***Проверка соединения по TCP для SNAT с ws22 на r1, а также проверка соединения по TCP для DNAT с r1 к ws22 (обращаемся по адресу r2 и порту 8080), (перед этим отключив NAT)***
  
  ![telnet](images/telnet.png)

### Part 8. Дополнительно. Знакомство с SSH Tunnels

+ ***Запускаем фаервол на r2***
  
+ ***Запускаем Apache на r2 на localhost:80***
  
  ![localhost](images/localhost.png)

+ ***Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21***
  
  ![ws21_to_ws22](images/ws21_to_ws22.png)

+ ***Воспользоваться Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11***
  
  ![ws11_to_ws22](images/ws11_to_ws22.png)

+ ***Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду:***
  
  ***Проверяем на ws11***
  
  ![telnet_ws11](images/telnet_ws11.png)

  ***Проверяем на ws21***

  ![telnet_ws21](images/telnet_ws21.png)